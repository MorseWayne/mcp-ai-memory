services:
  # Qdrant ÂêëÈáèÊï∞ÊçÆÂ∫ì
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant-vectordb
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-storage:/qdrant/storage
      - qdrant-snapshots:/qdrant/snapshots
    environment:
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Qdrant Ëá™Âä®Âø´ÁÖßÊúçÂä°
  qdrant-backup:
    image: alpine:latest
    container_name: qdrant-backup
    depends_on:
      qdrant:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - qdrant-snapshots:/snapshots
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-mem0_memories}
      - BACKUP_INTERVAL_HOURS=${BACKUP_INTERVAL_HOURS:-6}
      - BACKUP_RETAIN_COUNT=${BACKUP_RETAIN_COUNT:-7}
      # ‰ª£ÁêÜÈÖçÁΩÆÔºàÁî®‰∫é apk ÂÆâË£ÖËΩØ‰ª∂ÂåÖÔºåÂ∞Ü 127.0.0.1 ÊõøÊç¢‰∏∫ host.docker.internalÔºâ
      - HTTP_PROXY=${CONTAINER_HTTP_PROXY:-}
      - HTTPS_PROXY=${CONTAINER_HTTPS_PROXY:-}
      - http_proxy=${CONTAINER_HTTP_PROXY:-}
      - https_proxy=${CONTAINER_HTTPS_PROXY:-}
      - NO_PROXY=qdrant,localhost,127.0.0.1,host.docker.internal
      - no_proxy=qdrant,localhost,127.0.0.1,host.docker.internal
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl jq
        echo "Qdrant Ëá™Âä®Âø´ÁÖßÊúçÂä°Â∑≤ÂêØÂä®"
        echo "  - Â§á‰ªΩÈó¥Èöî: $${BACKUP_INTERVAL_HOURS} Â∞èÊó∂"
        echo "  - ‰øùÁïôÊï∞Èáè: $${BACKUP_RETAIN_COUNT} ‰∏™"
        
        while true; do
          echo "[`date '+%Y-%m-%d %H:%M:%S'`] ÂºÄÂßãÂàõÂª∫Âø´ÁÖß..."
          
          # Ëé∑ÂèñÊâÄÊúâ collections
          COLLECTIONS=$$(curl -s "http://$${QDRANT_HOST}:$${QDRANT_PORT}/collections" | jq -r '.result.collections[].name' 2>/dev/null)
          
          if [ -z "$$COLLECTIONS" ]; then
            echo "  Ë≠¶Âëä: Êú™ÊâæÂà∞‰ªª‰Ωï collection"
          else
            for COLL in $$COLLECTIONS; do
              echo "  Ê≠£Âú®Â§á‰ªΩ collection: $$COLL"
              
              # ÂàõÂª∫Âø´ÁÖß
              RESULT=$$(curl -s -X POST "http://$${QDRANT_HOST}:$${QDRANT_PORT}/collections/$$COLL/snapshots")
              SNAPSHOT_NAME=$$(echo "$$RESULT" | jq -r '.result.name' 2>/dev/null)
              
              if [ -n "$$SNAPSHOT_NAME" ] && [ "$$SNAPSHOT_NAME" != "null" ]; then
                echo "    ‚úÖ Âø´ÁÖßÂàõÂª∫ÊàêÂäü: $$SNAPSHOT_NAME"
                
                # Ê∏ÖÁêÜÊóßÂø´ÁÖß (‰øùÁïôÊúÄËøë N ‰∏™)
                SNAPSHOTS=$$(curl -s "http://$${QDRANT_HOST}:$${QDRANT_PORT}/collections/$$COLL/snapshots" | jq -r '.result[].name' 2>/dev/null | sort -r)
                COUNT=0
                for SNAP in $$SNAPSHOTS; do
                  COUNT=$$((COUNT + 1))
                  if [ $$COUNT -gt $${BACKUP_RETAIN_COUNT} ]; then
                    echo "    üóëÔ∏è Âà†Èô§ÊóßÂø´ÁÖß: $$SNAP"
                    curl -s -X DELETE "http://$${QDRANT_HOST}:$${QDRANT_PORT}/collections/$$COLL/snapshots/$$SNAP" > /dev/null
                  fi
                done
              else
                echo "    ‚ùå Âø´ÁÖßÂàõÂª∫Â§±Ë¥•: $$RESULT"
              fi
            done
          fi
          
          echo "[`date '+%Y-%m-%d %H:%M:%S'`] Âø´ÁÖßÂÆåÊàêÔºåÁ≠âÂæÖ $${BACKUP_INTERVAL_HOURS} Â∞èÊó∂..."
          sleep $${BACKUP_INTERVAL_HOURS}h
        done
    restart: unless-stopped

  # MCP AI Memory ÊúçÂä°
  mcp-ai-memory:
    image: mcp-ai-memory:latest
    build:
      context: .
      dockerfile: Dockerfile
      network: host
      args:
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        ALL_PROXY: ${ALL_PROXY:-}
        NO_PROXY: ${NO_PROXY:-}
    container_name: mcp-ai-memory
    depends_on:
      qdrant:
        condition: service_healthy
    ports:
      - "8050:8050"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      TRANSPORT: streamable-http
      HOST: 0.0.0.0
      PORT: 8050
      HTTP_PROXY: ${CONTAINER_HTTP_PROXY:-}
      HTTPS_PROXY: ${CONTAINER_HTTPS_PROXY:-}
      NO_PROXY: ${CONTAINER_NO_PROXY:-localhost,127.0.0.1,::1,host.docker.internal,qdrant,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}
      # Â∞èÂÜôÁâàÊú¨ÁöÑ‰ª£ÁêÜÂèòÈáèÔºàÊüê‰∫õ Python Â∫ìÈúÄË¶ÅÔºâ
      http_proxy: ${CONTAINER_HTTP_PROXY:-}
      https_proxy: ${CONTAINER_HTTPS_PROXY:-}
      no_proxy: ${CONTAINER_NO_PROXY:-localhost,127.0.0.1,::1,host.docker.internal,qdrant,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}
      # Á¶ÅÁî® Posthog ÈÅ•Êµã
      POSTHOG_DISABLED: "true"
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      LLM_BASE_URL: ${LLM_BASE_URL}
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_MODEL: ${LLM_MODEL:-gpt-4o-mini}
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-openai}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIMS: ${EMBEDDING_DIMS:-1536}
      EMBEDDING_BASE_URL: ${EMBEDDING_BASE_URL:-${LLM_BASE_URL}}
      EMBEDDING_API_KEY: ${EMBEDDING_API_KEY:-${LLM_API_KEY}}
      VECTOR_STORE_PROVIDER: qdrant
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-mem0_memories}
      QDRANT_ON_DISK: ${QDRANT_ON_DISK:-false}
      DEFAULT_USER_ID: ${DEFAULT_USER_ID:-default_user}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/8050' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  qdrant-storage:
    driver: local
  qdrant-snapshots:
    driver: local
